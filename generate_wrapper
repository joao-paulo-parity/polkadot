#!/bin/bash

# -nodefaultlibs and -nostartfiles will be ignored (they are usually only passed
# in when the linker is called by the Rust compiler because we'll be using
# musl-gcc for the linker and it includes the adequate files with those flags

echo "#!/bin/bash

set -eu

echo \"BEFORE \$@\" >> /tmp/args.txt

args=()

for arg in \"\$@\"; do
  case \"\$arg\" in
    -Bsymbolic|-symbolic|-Bdynamic|-dynamic|-dy|-shared*|-nodefaultlibs|-nostartfiles|-call_shared) continue ;;
    *.so|*.so.*) echo \"Detected dynamic object: \$@\" > /tmp/log2.txt; exit 1;;
  esac

  args+=(\"\$arg\")
done

echo \"AFTER \${args[@]}\" >> /tmp/args.txt

$1 \"\${args[@]}\"
"
