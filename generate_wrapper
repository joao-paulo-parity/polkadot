#!/bin/bash

echo "#!/bin/bash

set -eu

args=()

for arg in \"\$@\"; do
  case \"\$arg\" in
    -Bdynamic|-dynamic|-shared*|-symbolic|-nodefaultlibs|-lstdc++) continue ;;
    *.so|*.so.*) echo \"Arguments: $@\" > /tmp/log2.txt; exit 1;;
  esac

  # replace built-in rust target's runtime files with musl's
  if [[ \"\$arg\" =~ ^/.+/([^.]*.o)\$ ]]; then
    obj=\"\$TARGET_HOME/lib/\${BASH_REMATCH[1]}\"
    if [[ -e \"\$obj\" ]]; then
      args+=(\"\$obj\")
      continue
    fi
  fi

  # remove anything added by the rust compiler since we're adding what's needed
  # ourselves
  if [[ \"\$arg\" = *"/rustlib/\$TARGET/lib"* ]]; then
    continue
  fi

  args+=(\"\$arg\")
done

$1 \"\${args[@]}\"
"
